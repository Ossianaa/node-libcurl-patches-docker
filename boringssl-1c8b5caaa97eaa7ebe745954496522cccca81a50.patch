From 1c82423057845c92c512d3f3d1125e28981117fb Mon Sep 17 00:00:00 2001
From: Ossian <857984597@qq.com>
Date: Fri, 13 Feb 2026 07:53:17 +0800
Subject: [PATCH 1/3] patch

---
 include/openssl/ssl.h         |   3 +
 include/openssl/tls1.h        |   1 +
 ssl/encrypted_client_hello.cc |   4 +-
 ssl/extensions.cc             | 579 +++++++++++++++++++---------------
 ssl/handshake_client.cc       |  48 ++-
 ssl/internal.h                |   5 +-
 ssl/ssl_cipher.cc             | 178 ++++++++++-
 ssl/ssl_key_share.cc          |   4 +
 ssl/ssl_lib.cc                |  39 ++-
 tool/server.cc                |   2 +-
 10 files changed, 580 insertions(+), 283 deletions(-)

diff --git a/include/openssl/ssl.h b/include/openssl/ssl.h
index 7d9499dbc..5f33229d1 100644
--- a/include/openssl/ssl.h
+++ b/include/openssl/ssl.h
@@ -6011,6 +6011,9 @@ OPENSSL_EXPORT int SSL_CTX_set1_curves_list(SSL_CTX *ctx, const char *curves);
 // SSL_set1_curves_list calls |SSL_set1_groups_list|.
 OPENSSL_EXPORT int SSL_set1_curves_list(SSL *ssl, const char *curves);
 
+OPENSSL_EXPORT int SSL_CTX_set_ciphersuites(SSL_CTX* ctx, char* str);
+
+OPENSSL_EXPORT int SSL_CTX_set_extension_permutation(SSL_CTX* ctx, char* str);
 // TLSEXT_nid_unknown is a constant used in OpenSSL for
 // |SSL_get_negotiated_group| to return an unrecognized group. BoringSSL never
 // returns this value, but we define this constant for compatibility.
diff --git a/include/openssl/tls1.h b/include/openssl/tls1.h
index 696ccfd4a..7e6aa1923 100644
--- a/include/openssl/tls1.h
+++ b/include/openssl/tls1.h
@@ -48,6 +48,7 @@ extern "C" {
 #define TLS1_AD_NO_APPLICATION_PROTOCOL 120
 #define TLS1_AD_ECH_REQUIRED 121  // draft-ietf-tls-esni-13
 
+#define TLSEXT_TYPE_record_size_limit 28
 // ExtensionType values from RFC 6066
 #define TLSEXT_TYPE_server_name 0
 #define TLSEXT_TYPE_status_request 5
diff --git a/ssl/encrypted_client_hello.cc b/ssl/encrypted_client_hello.cc
index 44a3c0341..e8d459b5e 100644
--- a/ssl/encrypted_client_hello.cc
+++ b/ssl/encrypted_client_hello.cc
@@ -736,9 +736,7 @@ static bool setup_ech_grease(SSL_HANDSHAKE *hs) {
   }
 
   const uint16_t kdf_id = EVP_HPKE_HKDF_SHA256;
-  const bool has_aes_hw = hs->ssl->config->aes_hw_override
-                              ? hs->ssl->config->aes_hw_override_value
-                              : EVP_has_aes_hardware();
+  const bool has_aes_hw = true;//always use AES-128-GCM on chrome
   const EVP_HPKE_AEAD *aead =
       has_aes_hw ? EVP_hpke_aes_128_gcm() : EVP_hpke_chacha20_poly1305();
   static_assert(ssl_grease_ech_config_id < sizeof(hs->grease_seed),
diff --git a/ssl/extensions.cc b/ssl/extensions.cc
index daf643572..dca1ee323 100644
--- a/ssl/extensions.cc
+++ b/ssl/extensions.cc
@@ -300,7 +300,7 @@ static const uint16_t kVerifySignatureAlgorithms[] = {
     SSL_SIGN_RSA_PKCS1_SHA512,
 
     // For now, SHA-1 is still accepted but least preferable.
-    SSL_SIGN_RSA_PKCS1_SHA1,
+    //SSL_SIGN_RSA_PKCS1_SHA1,
 };
 
 // kSignSignatureAlgorithms is the default list of supported signature
@@ -324,8 +324,8 @@ static const uint16_t kSignSignatureAlgorithms[] = {
     SSL_SIGN_RSA_PKCS1_SHA512,
 
     // If the peer supports nothing else, sign with SHA-1.
-    SSL_SIGN_ECDSA_SHA1,
-    SSL_SIGN_RSA_PKCS1_SHA1,
+    //SSL_SIGN_ECDSA_SHA1,
+    //SSL_SIGN_RSA_PKCS1_SHA1,
 };
 
 static Span<const uint16_t> tls12_get_verify_sigalgs(const SSL_HANDSHAKE *hs) {
@@ -1133,20 +1133,20 @@ static bool ext_ocsp_add_serverhello(SSL_HANDSHAKE *hs, CBB *out) {
 static bool ext_npn_add_clienthello(const SSL_HANDSHAKE *hs, CBB *out,
                                     CBB *out_compressible,
                                     ssl_client_hello_type_t type) {
-  const SSL *const ssl = hs->ssl;
-  if (ssl->ctx->next_proto_select_cb == nullptr ||
-      // Do not allow NPN to change on renegotiation.
-      ssl->s3->initial_handshake_complete ||
-      // NPN is not defined in DTLS or TLS 1.3.
-      SSL_is_dtls(ssl) || hs->min_version >= TLS1_3_VERSION ||
-      type == ssl_client_hello_inner) {
-    return true;
-  }
-
-  if (!CBB_add_u16(out, TLSEXT_TYPE_next_proto_neg) ||
-      !CBB_add_u16(out, 0 /* length */)) {
-    return false;
-  }
+  //const SSL *const ssl = hs->ssl;
+  //if (ssl->ctx->next_proto_select_cb == NULL ||
+  //    // Do not allow NPN to change on renegotiation.
+  //    ssl->s3->initial_handshake_complete ||
+  //    // NPN is not defined in DTLS or TLS 1.3.
+  //    SSL_is_dtls(ssl) || hs->min_version >= TLS1_3_VERSION ||
+  //    type == ssl_client_hello_inner) {
+  //  return true;
+  //}
+
+  //if (!CBB_add_u16(out, TLSEXT_TYPE_next_proto_neg) ||
+  //    !CBB_add_u16(out, 0 /* length */)) {
+  //  return false;
+  //}
 
   return true;
 }
@@ -2652,41 +2652,39 @@ static bool ext_supported_groups_parse_clienthello(SSL_HANDSHAKE *hs,
 //
 // https://tools.ietf.org/html/rfc8446#section-4.2.4
 
-static bool ext_certificate_authorities_add_clienthello(
-    const SSL_HANDSHAKE *hs, CBB *out, CBB *out_compressible,
-    ssl_client_hello_type_t type) {
-  // TODO(crbug.com/398275713): What should this send in ClientHelloOuter?
-  if (ssl_has_CA_names(hs->config)) {
-    CBB ca_contents;
-    if (!CBB_add_u16(out_compressible,
-                     TLSEXT_TYPE_certificate_authorities) ||             //
-        !CBB_add_u16_length_prefixed(out_compressible, &ca_contents) ||  //
-        !ssl_add_CA_names(hs, &ca_contents) ||                           //
-        !CBB_flush(out_compressible)) {
-      return false;
-    }
-  }
-  return true;
-}
-
-static bool ext_certificate_authorities_parse_clienthello(SSL_HANDSHAKE *hs,
-                                                          uint8_t *out_alert,
-                                                          CBS *contents) {
-  if (contents == nullptr) {
-    return true;
-  }
-
-  if (CBS_len(contents) == 0) {
-    return false;
-  }
-
-  hs->ca_names = SSL_parse_CA_list(hs->ssl, out_alert, contents);
-  if (!hs->ca_names) {
-    return false;
-  }
-
-  return true;
-}
+//static bool ext_certificate_authorities_add_clienthello(
+//    const SSL_HANDSHAKE *hs, CBB *out, CBB *out_compressible,
+//    ssl_client_hello_type_t type) {
+//  if (ssl_has_CA_names(hs->config)) {
+//    CBB ca_contents;
+//    if (!CBB_add_u16(out, TLSEXT_TYPE_certificate_authorities) ||  //
+//        !CBB_add_u16_length_prefixed(out, &ca_contents) ||         //
+//        !ssl_add_CA_names(hs, &ca_contents) ||                     //
+//        !CBB_flush(out)) {
+//      return false;
+//    }
+//  }
+//  return true;
+//}
+
+//static bool ext_certificate_authorities_parse_clienthello(SSL_HANDSHAKE *hs,
+//                                                          uint8_t *out_alert,
+//                                                          CBS *contents) {
+//  if (contents == NULL) {
+//    return true;
+//  }
+//
+//  if (CBS_len(contents) == 0) {
+//    return false;
+//  }
+//
+//  hs->ca_names = SSL_parse_CA_list(hs->ssl, out_alert, contents);
+//  if (!hs->ca_names) {
+//    return false;
+//  }
+//
+//  return true;
+//}
 
 
 // Trust Anchor Identifiers
@@ -3013,6 +3011,24 @@ static bool ext_quic_transport_params_add_serverhello_legacy(SSL_HANDSHAKE *hs,
 static bool ext_delegated_credential_add_clienthello(
     const SSL_HANDSHAKE *hs, CBB *out, CBB *out_compressible,
     ssl_client_hello_type_t type) {
+    CBB contents, data;
+    static const uint16_t signature_hash_algorithms[] = {
+    SSL_SIGN_ECDSA_SECP256R1_SHA256, SSL_SIGN_ECDSA_SECP384R1_SHA384,
+    SSL_SIGN_ECDSA_SECP521R1_SHA512, SSL_SIGN_ECDSA_SHA1 };
+    if (!CBB_add_u16(out, TLSEXT_TYPE_delegated_credential) ||
+            !CBB_add_u16_length_prefixed(out, &contents) ||
+            !CBB_add_u16_length_prefixed(&contents, &data)) {
+        return false;
+    }
+
+    for (const uint16_t alg : signature_hash_algorithms) {
+        if (!CBB_add_u16(&data, alg)) {
+            return false;
+        }
+    }
+    if (!CBB_flush(out)) {
+        return false;
+    }
   return true;
 }
 
@@ -3385,14 +3401,10 @@ static bool ext_alps_add_clienthello_impl(const SSL_HANDSHAKE *hs, CBB *out,
       ssl->s3->initial_handshake_complete) {
     return true;
   }
-
-  if (use_new_codepoint != hs->config->alps_use_new_codepoint) {
-    // Do nothing, we'll send the other codepoint.
-    return true;
-  }
+  hs->config->alps_use_new_codepoint = use_new_codepoint;
 
   uint16_t extension_type = TLSEXT_TYPE_application_settings_old;
-  if (hs->config->alps_use_new_codepoint) {
+  if (use_new_codepoint) {
     extension_type = TLSEXT_TYPE_application_settings;
   }
 
@@ -3459,7 +3471,8 @@ static bool ext_alps_parse_serverhello_impl(SSL_HANDSHAKE *hs,
   return true;
 }
 
-static bool ext_alps_parse_serverhello(SSL_HANDSHAKE *hs, uint8_t *out_alert,
+static bool ext_alps_parse_serverhello(SSL_HANDSHAKE *hs,
+                                       uint8_t *out_alert,
                                        CBS *contents) {
   return ext_alps_parse_serverhello_impl(hs, out_alert, contents,
                                          /*use_new_codepoint=*/true);
@@ -3569,194 +3582,223 @@ bool ssl_negotiate_alps(SSL_HANDSHAKE *hs, uint8_t *out_alert,
   return true;
 }
 
+
+static bool record_size_limit_add_clienthello(const SSL_HANDSHAKE* hs, CBB* out,
+    CBB* out_compressible,
+    ssl_client_hello_type_t type) {
+    CBB data;
+    const uint16_t data_ = 0x4001;
+    if (!CBB_add_u16(out, TLSEXT_TYPE_record_size_limit) ||
+        !CBB_add_u16_length_prefixed(out, &data) || !CBB_add_u16(&data, data_) ||
+        !CBB_flush(out)) {
+        return false;
+    }
+    return true;
+}
+
+static bool record_size_limit_parse_serverhello(SSL_HANDSHAKE* hs,
+    uint8_t* out_alert,
+    CBS* contents) {
+    return true;
+}
+
+static bool record_size_limit_parse_clienthello(SSL_HANDSHAKE* hs,
+    uint8_t* out_alert,
+    CBS* contents) {
+    return true;
+}
+
+static bool record_size_limit_add_serverhello(SSL_HANDSHAKE* hs, CBB* out) {
+    return true;
+}
 // kExtensions contains all the supported extensions.
 static const struct tls_extension kExtensions[] = {
-    {
-        TLSEXT_TYPE_server_name,
-        ext_sni_add_clienthello,
-        ext_sni_parse_serverhello,
-        ext_sni_parse_clienthello,
-        ext_sni_add_serverhello,
-    },
-    {
-        TLSEXT_TYPE_encrypted_client_hello,
-        ext_ech_add_clienthello,
-        ext_ech_parse_serverhello,
-        ext_ech_parse_clienthello,
-        ext_ech_add_serverhello,
-    },
-    {
-        TLSEXT_TYPE_extended_master_secret,
-        ext_ems_add_clienthello,
-        ext_ems_parse_serverhello,
-        ext_ems_parse_clienthello,
-        ext_ems_add_serverhello,
-    },
-    {
-        TLSEXT_TYPE_renegotiate,
-        ext_ri_add_clienthello,
-        ext_ri_parse_serverhello,
-        ext_ri_parse_clienthello,
-        ext_ri_add_serverhello,
-    },
-    {
-        TLSEXT_TYPE_supported_groups,
-        ext_supported_groups_add_clienthello,
-        ext_supported_groups_parse_serverhello,
-        ext_supported_groups_parse_clienthello,
-        dont_add_serverhello,
-    },
-    {
-        TLSEXT_TYPE_ec_point_formats,
-        ext_ec_point_add_clienthello,
-        ext_ec_point_parse_serverhello,
-        ext_ec_point_parse_clienthello,
-        ext_ec_point_add_serverhello,
-    },
-    {
-        TLSEXT_TYPE_session_ticket,
-        ext_ticket_add_clienthello,
-        ext_ticket_parse_serverhello,
-        // Ticket extension client parsing is handled in ssl_session.c
-        ignore_parse_clienthello,
-        ext_ticket_add_serverhello,
-    },
-    {
-        TLSEXT_TYPE_application_layer_protocol_negotiation,
-        ext_alpn_add_clienthello,
-        ext_alpn_parse_serverhello,
-        // ALPN is negotiated late in |ssl_negotiate_alpn|.
-        ignore_parse_clienthello,
-        ext_alpn_add_serverhello,
-    },
-    {
-        TLSEXT_TYPE_status_request,
-        ext_ocsp_add_clienthello,
-        ext_ocsp_parse_serverhello,
-        ext_ocsp_parse_clienthello,
-        ext_ocsp_add_serverhello,
-    },
-    {
-        TLSEXT_TYPE_signature_algorithms,
-        ext_sigalgs_add_clienthello,
-        forbid_parse_serverhello,
-        ext_sigalgs_parse_clienthello,
-        dont_add_serverhello,
-    },
-    {
-        TLSEXT_TYPE_next_proto_neg,
-        ext_npn_add_clienthello,
-        ext_npn_parse_serverhello,
-        ext_npn_parse_clienthello,
-        ext_npn_add_serverhello,
-    },
-    {
-        TLSEXT_TYPE_certificate_timestamp,
-        ext_sct_add_clienthello,
-        ext_sct_parse_serverhello,
-        ext_sct_parse_clienthello,
-        ext_sct_add_serverhello,
-    },
-    {
-        TLSEXT_TYPE_channel_id,
-        ext_channel_id_add_clienthello,
-        ext_channel_id_parse_serverhello,
-        ext_channel_id_parse_clienthello,
-        ext_channel_id_add_serverhello,
-    },
-    {
-        TLSEXT_TYPE_srtp,
-        ext_srtp_add_clienthello,
-        ext_srtp_parse_serverhello,
-        ext_srtp_parse_clienthello,
-        ext_srtp_add_serverhello,
-    },
-    {
-        TLSEXT_TYPE_key_share,
-        ext_key_share_add_clienthello,
-        forbid_parse_serverhello,
-        ignore_parse_clienthello,
-        dont_add_serverhello,
-    },
-    {
-        TLSEXT_TYPE_psk_key_exchange_modes,
-        ext_psk_key_exchange_modes_add_clienthello,
-        forbid_parse_serverhello,
-        ext_psk_key_exchange_modes_parse_clienthello,
-        dont_add_serverhello,
-    },
-    {
-        TLSEXT_TYPE_early_data,
-        ext_early_data_add_clienthello,
-        ext_early_data_parse_serverhello,
-        ext_early_data_parse_clienthello,
-        ext_early_data_add_serverhello,
-    },
-    {
-        TLSEXT_TYPE_supported_versions,
-        ext_supported_versions_add_clienthello,
-        forbid_parse_serverhello,
-        ignore_parse_clienthello,
-        dont_add_serverhello,
-    },
-    {
-        TLSEXT_TYPE_cookie,
-        ext_cookie_add_clienthello,
-        forbid_parse_serverhello,
-        ignore_parse_clienthello,
-        dont_add_serverhello,
-    },
-    {
-        TLSEXT_TYPE_quic_transport_parameters,
-        ext_quic_transport_params_add_clienthello,
-        ext_quic_transport_params_parse_serverhello,
-        ext_quic_transport_params_parse_clienthello,
-        ext_quic_transport_params_add_serverhello,
-    },
-    {
-        TLSEXT_TYPE_quic_transport_parameters_legacy,
-        ext_quic_transport_params_add_clienthello_legacy,
-        ext_quic_transport_params_parse_serverhello_legacy,
-        ext_quic_transport_params_parse_clienthello_legacy,
-        ext_quic_transport_params_add_serverhello_legacy,
-    },
-    {
-        TLSEXT_TYPE_cert_compression,
-        cert_compression_add_clienthello,
-        cert_compression_parse_serverhello,
-        cert_compression_parse_clienthello,
-        cert_compression_add_serverhello,
-    },
-    {
-        TLSEXT_TYPE_delegated_credential,
-        ext_delegated_credential_add_clienthello,
-        forbid_parse_serverhello,
-        ext_delegated_credential_parse_clienthello,
-        dont_add_serverhello,
-    },
-    {
-        TLSEXT_TYPE_application_settings,
-        ext_alps_add_clienthello,
-        ext_alps_parse_serverhello,
-        // ALPS is negotiated late in |ssl_negotiate_alpn|.
-        ignore_parse_clienthello,
-        ext_alps_add_serverhello,
-    },
-    {
-        TLSEXT_TYPE_application_settings_old,
-        ext_alps_add_clienthello_old,
-        ext_alps_parse_serverhello_old,
-        // ALPS is negotiated late in |ssl_negotiate_alpn|.
-        ignore_parse_clienthello,
-        ext_alps_add_serverhello_old,
-    },
-    {
-        TLSEXT_TYPE_certificate_authorities,
-        ext_certificate_authorities_add_clienthello,
-        forbid_parse_serverhello,
-        ext_certificate_authorities_parse_clienthello,
-        dont_add_serverhello,
-    },
+  {
+    TLSEXT_TYPE_server_name,
+    ext_sni_add_clienthello,
+    ext_sni_parse_serverhello,
+    ext_sni_parse_clienthello,
+    ext_sni_add_serverhello,
+  },
+  {
+    TLSEXT_TYPE_encrypted_client_hello,
+    ext_ech_add_clienthello,
+    ext_ech_parse_serverhello,
+    ext_ech_parse_clienthello,
+    ext_ech_add_serverhello,
+  },
+  {
+    TLSEXT_TYPE_extended_master_secret,
+    ext_ems_add_clienthello,
+    ext_ems_parse_serverhello,
+    ext_ems_parse_clienthello,
+    ext_ems_add_serverhello,
+  },
+  {
+    TLSEXT_TYPE_renegotiate,
+    ext_ri_add_clienthello,
+    ext_ri_parse_serverhello,
+    ext_ri_parse_clienthello,
+    ext_ri_add_serverhello,
+  },
+  {
+    TLSEXT_TYPE_supported_groups,
+    ext_supported_groups_add_clienthello,
+    ext_supported_groups_parse_serverhello,
+    ext_supported_groups_parse_clienthello,
+    dont_add_serverhello,
+  },
+  {
+    TLSEXT_TYPE_ec_point_formats,
+    ext_ec_point_add_clienthello,
+    ext_ec_point_parse_serverhello,
+    ext_ec_point_parse_clienthello,
+    ext_ec_point_add_serverhello,
+  },
+  {
+    TLSEXT_TYPE_session_ticket,
+    ext_ticket_add_clienthello,
+    ext_ticket_parse_serverhello,
+    // Ticket extension client parsing is handled in ssl_session.c
+    ignore_parse_clienthello,
+    ext_ticket_add_serverhello,
+  },
+  {
+    TLSEXT_TYPE_application_layer_protocol_negotiation,
+    ext_alpn_add_clienthello,
+    ext_alpn_parse_serverhello,
+    // ALPN is negotiated late in |ssl_negotiate_alpn|.
+    ignore_parse_clienthello,
+    ext_alpn_add_serverhello,
+  },
+  {
+    TLSEXT_TYPE_status_request,
+    ext_ocsp_add_clienthello,
+    ext_ocsp_parse_serverhello,
+    ext_ocsp_parse_clienthello,
+    ext_ocsp_add_serverhello,
+  },
+  {
+    TLSEXT_TYPE_signature_algorithms,
+    ext_sigalgs_add_clienthello,
+    forbid_parse_serverhello,
+    ext_sigalgs_parse_clienthello,
+    dont_add_serverhello,
+  },
+  {
+    TLSEXT_TYPE_next_proto_neg,
+    ext_npn_add_clienthello,
+    ext_npn_parse_serverhello,
+    ext_npn_parse_clienthello,
+    ext_npn_add_serverhello,
+  },
+  {
+    TLSEXT_TYPE_certificate_timestamp,
+    ext_sct_add_clienthello,
+    ext_sct_parse_serverhello,
+    ext_sct_parse_clienthello,
+    ext_sct_add_serverhello,
+  },
+  {
+    TLSEXT_TYPE_channel_id,
+    ext_channel_id_add_clienthello,
+    ext_channel_id_parse_serverhello,
+    ext_channel_id_parse_clienthello,
+    ext_channel_id_add_serverhello,
+  },
+  {
+    TLSEXT_TYPE_srtp,
+    ext_srtp_add_clienthello,
+    ext_srtp_parse_serverhello,
+    ext_srtp_parse_clienthello,
+    ext_srtp_add_serverhello,
+  },
+  {
+    TLSEXT_TYPE_key_share,
+    ext_key_share_add_clienthello,
+    forbid_parse_serverhello,
+    ignore_parse_clienthello,
+    dont_add_serverhello,
+  },
+  {
+    TLSEXT_TYPE_psk_key_exchange_modes,
+    ext_psk_key_exchange_modes_add_clienthello,
+    forbid_parse_serverhello,
+    ext_psk_key_exchange_modes_parse_clienthello,
+    dont_add_serverhello,
+  },
+  {
+    TLSEXT_TYPE_early_data,
+    ext_early_data_add_clienthello,
+    ext_early_data_parse_serverhello,
+    ext_early_data_parse_clienthello,
+    ext_early_data_add_serverhello,
+  },
+  {
+    TLSEXT_TYPE_supported_versions,
+    ext_supported_versions_add_clienthello,
+    forbid_parse_serverhello,
+    ignore_parse_clienthello,
+    dont_add_serverhello,
+  },
+  {
+    TLSEXT_TYPE_cookie,
+    ext_cookie_add_clienthello,
+    forbid_parse_serverhello,
+    ignore_parse_clienthello,
+    dont_add_serverhello,
+  },
+  {
+    TLSEXT_TYPE_quic_transport_parameters,
+    ext_quic_transport_params_add_clienthello,
+    ext_quic_transport_params_parse_serverhello,
+    ext_quic_transport_params_parse_clienthello,
+    ext_quic_transport_params_add_serverhello,
+  },
+  {
+    TLSEXT_TYPE_quic_transport_parameters_legacy,
+    ext_quic_transport_params_add_clienthello_legacy,
+    ext_quic_transport_params_parse_serverhello_legacy,
+    ext_quic_transport_params_parse_clienthello_legacy,
+    ext_quic_transport_params_add_serverhello_legacy,
+  },
+  {
+    TLSEXT_TYPE_cert_compression,
+    cert_compression_add_clienthello,
+    cert_compression_parse_serverhello,
+    cert_compression_parse_clienthello,
+    cert_compression_add_serverhello,
+  },
+  {
+    TLSEXT_TYPE_delegated_credential,
+    ext_delegated_credential_add_clienthello,
+    forbid_parse_serverhello,
+    ext_delegated_credential_parse_clienthello,
+    dont_add_serverhello,
+  },
+  {
+    TLSEXT_TYPE_application_settings,
+    ext_alps_add_clienthello,
+    ext_alps_parse_serverhello,
+    // ALPS is negotiated late in |ssl_negotiate_alpn|.
+    ignore_parse_clienthello,
+    ext_alps_add_serverhello,
+  },
+  {
+    TLSEXT_TYPE_application_settings_old,
+    ext_alps_add_clienthello_old,
+    ext_alps_parse_serverhello_old,
+    // ALPS is negotiated late in |ssl_negotiate_alpn|.
+    ignore_parse_clienthello,
+    ext_alps_add_serverhello_old,
+  },
+  {
+    TLSEXT_TYPE_record_size_limit,
+    record_size_limit_add_clienthello,
+    record_size_limit_parse_serverhello,
+    record_size_limit_parse_clienthello,
+    record_size_limit_add_serverhello,
+  },
     {
         TLSEXT_TYPE_pake,
         ext_pake_add_clienthello,
@@ -3786,6 +3828,12 @@ static_assert(kNumExtensions <=
 
 bool ssl_setup_extension_permutation(SSL_HANDSHAKE *hs) {
   if (!hs->config->permute_extensions) {
+      if (!hs->ssl->ctx->extension_permutation.empty()) {
+          Array<uint8_t> permutation;
+          (void)permutation.Init(hs->ssl->ctx->extension_permutation.size());
+          (void)permutation.CopyFrom(hs->ssl->ctx->extension_permutation);
+          hs->extension_permutation = std::move(permutation);
+      }
     return true;
   }
 
@@ -3861,11 +3909,16 @@ static bool ssl_add_clienthello_tlsext_inner(SSL_HANDSHAKE *hs, CBB *out,
       return false;
     }
   }
-
-  for (size_t unpermuted = 0; unpermuted < kNumExtensions; unpermuted++) {
+  const size_t numExtensions = hs->extension_permutation.empty()
+      ? kNumExtensions
+      : hs->extension_permutation.size();
+  for (size_t unpermuted = 0; unpermuted < numExtensions; unpermuted++) {
     size_t i = hs->extension_permutation.empty()
                    ? unpermuted
                    : hs->extension_permutation[unpermuted];
+    if (i >= kNumExtensions) {
+        continue;
+    }
     const size_t len_before = CBB_len(&extensions);
     const size_t len_compressed_before = CBB_len(compressed.get());
     if (!kExtensions[i].add_clienthello(hs, &extensions, compressed.get(),
@@ -3975,10 +4028,22 @@ bool ssl_add_clienthello_tlsext(SSL_HANDSHAKE *hs, CBB *out, CBB *out_encoded,
   }
 
   bool last_was_empty = false;
-  for (size_t unpermuted = 0; unpermuted < kNumExtensions; unpermuted++) {
+  bool hasPreSharedKey = false;
+  const size_t numExtensions = hs->extension_permutation.empty()
+      ? kNumExtensions
+      : hs->extension_permutation.size();
+  for (size_t unpermuted = 0; unpermuted < numExtensions; unpermuted++) {
     size_t i = hs->extension_permutation.empty()
                    ? unpermuted
                    : hs->extension_permutation[unpermuted];
+    if (i == 126)
+    {
+        hasPreSharedKey = true;
+        continue;
+    }
+    if (i >= kNumExtensions) {
+        continue;
+    }
     const size_t len_before = CBB_len(&extensions);
     if (!kExtensions[i].add_clienthello(hs, &extensions, &extensions, type)) {
       OPENSSL_PUT_ERROR(SSL, SSL_R_ERROR_ADDING_EXTENSION);
@@ -4052,14 +4117,24 @@ bool ssl_add_clienthello_tlsext(SSL_HANDSHAKE *hs, CBB *out, CBB *out_encoded,
     }
   }
 
+   if (hasPreSharedKey)
+   {
   // The PSK extension must be last, including after the padding.
-  size_t psk_len_actual;
-  if (!ext_pre_shared_key_add_clienthello(hs, out, &extensions, &psk_len_actual,
+  const size_t len_before = CBB_len(&extensions);
+  if (!ext_pre_shared_key_add_clienthello(hs, &extensions, out_needs_psk_binder,
                                           type)) {
+    OPENSSL_PUT_ERROR(SSL, ERR_R_INTERNAL_ERROR);
     return false;
   }
-  assert(psk_len_actual == psk_len);
-  return true;
+  assert(psk_extension_len == CBB_len(&extensions) - len_before);
+  (void)len_before;  // |assert| is omitted in release builds.
+}
+  // Discard empty extensions blocks.
+  if (CBB_len(&extensions) == 0) {
+    CBB_discard_child(out);
+  }
+
+  return CBB_flush(out);
 }
 
 bool ssl_add_serverhello_tlsext(SSL_HANDSHAKE *hs, CBB *out) {
diff --git a/ssl/handshake_client.cc b/ssl/handshake_client.cc
index 901040c2a..bab8d2730 100644
--- a/ssl/handshake_client.cc
+++ b/ssl/handshake_client.cc
@@ -111,39 +111,63 @@ static bool ssl_write_client_cipher_list(const SSL_HANDSHAKE *hs, CBB *out,
   // Add TLS 1.3 ciphers. Order ChaCha20-Poly1305 relative to AES-GCM based on
   // hardware support.
   if (hs->max_version >= TLS1_3_VERSION) {
+    if (!ssl->ctx->cipher13_flag_list.empty()) {
+        for (uint8_t flag : ssl->ctx->cipher13_flag_list) {
+            int id = 0;
+            switch (flag) {
+            case 1:
+                id = TLS1_3_CK_AES_128_GCM_SHA256;
+                break;
+            case 2:
+                id = TLS1_3_CK_AES_256_GCM_SHA384;
+                break;
+            case 3:
+                id = TLS1_3_CK_CHACHA20_POLY1305_SHA256;
+                break;
+            default:
+                return false;
+            }
+            if (!CBB_add_u16(&child, id & 0xffff)) {
+                return false;
+            }
+        }
+    }
+    else {
     static const uint16_t kCiphersNoAESHardware[] = {
-        SSL_CIPHER_CHACHA20_POLY1305_SHA256,
-        SSL_CIPHER_AES_128_GCM_SHA256,
-        SSL_CIPHER_AES_256_GCM_SHA384,
+        TLS1_3_CK_CHACHA20_POLY1305_SHA256 & 0xffff,
+        TLS1_3_CK_AES_128_GCM_SHA256 & 0xffff,
+        TLS1_3_CK_AES_256_GCM_SHA384 & 0xffff,
     };
     static const uint16_t kCiphersAESHardware[] = {
-        SSL_CIPHER_AES_128_GCM_SHA256,
-        SSL_CIPHER_AES_256_GCM_SHA384,
-        SSL_CIPHER_CHACHA20_POLY1305_SHA256,
+        TLS1_3_CK_AES_128_GCM_SHA256 & 0xffff,
+        TLS1_3_CK_AES_256_GCM_SHA384 & 0xffff,
+        TLS1_3_CK_CHACHA20_POLY1305_SHA256 & 0xffff,
     };
     static const uint16_t kCiphersCNSA[] = {
-        SSL_CIPHER_AES_256_GCM_SHA384,
-        SSL_CIPHER_AES_128_GCM_SHA256,
-        SSL_CIPHER_CHACHA20_POLY1305_SHA256,
+        TLS1_3_CK_AES_256_GCM_SHA384 & 0xffff,
+        TLS1_3_CK_AES_128_GCM_SHA256 & 0xffff,
+        TLS1_3_CK_CHACHA20_POLY1305_SHA256 & 0xffff,
     };
 
     const bool has_aes_hw = ssl->config->aes_hw_override
                                 ? ssl->config->aes_hw_override_value
                                 : EVP_has_aes_hardware();
     const bssl::Span<const uint16_t> ciphers =
-        ssl->config->compliance_policy == ssl_compliance_policy_cnsa_202407
+        ssl->config->tls13_cipher_policy == ssl_compliance_policy_cnsa_202407
             ? bssl::Span<const uint16_t>(kCiphersCNSA)
             : (has_aes_hw ? bssl::Span<const uint16_t>(kCiphersAESHardware)
                           : bssl::Span<const uint16_t>(kCiphersNoAESHardware));
 
     for (auto cipher : ciphers) {
       if (!ssl_add_tls13_cipher(&child, cipher,
-                                ssl->config->compliance_policy)) {
+                                ssl->config->tls13_cipher_policy)) {
         return false;
       }
     }
   }
 
+  }
+
   if (hs->min_version < TLS1_3_VERSION && type != ssl_client_hello_inner) {
     bool any_enabled = false;
     for (const SSL_CIPHER *cipher : SSL_get_ciphers(ssl)) {
@@ -329,7 +353,6 @@ void ssl_done_writing_client_hello(SSL_HANDSHAKE *hs) {
 
 static enum ssl_hs_wait_t do_start_connect(SSL_HANDSHAKE *hs) {
   SSL *const ssl = hs->ssl;
-
   ssl_do_info_callback(ssl, SSL_CB_HANDSHAKE_START, 1);
   // |session_reused| must be reset in case this is a renegotiation.
   ssl->s3->session_reused = false;
@@ -417,7 +440,6 @@ static enum ssl_hs_wait_t do_start_connect(SSL_HANDSHAKE *hs) {
   } else {
     hs->early_data_offered = true;
   }
-
   if (!ssl_setup_key_shares(hs, /*override_group_id=*/0) ||
       !ssl_setup_extension_permutation(hs) ||
       !ssl_encrypt_client_hello(hs, Span(ech_enc, ech_enc_len)) ||
diff --git a/ssl/internal.h b/ssl/internal.h
index 9053d88e9..db8aaadd3 100644
--- a/ssl/internal.h
+++ b/ssl/internal.h
@@ -282,8 +282,9 @@ BSSL_NAMESPACE_BEGIN
 // Bits for |algorithm_mac| (symmetric authentication).
 #define SSL_SHA1 0x00000001u
 #define SSL_SHA256 0x00000002u
+#define SSL_SHA384 0x00000004u
 // SSL_AEAD is set for all AEADs.
-#define SSL_AEAD 0x00000004u
+#define SSL_AEAD 0x00000008u
 
 // Bits for |algorithm_prf| (handshake digest).
 #define SSL_HANDSHAKE_MAC_DEFAULT 0x1
@@ -4026,6 +4027,8 @@ struct ssl_ctx_st : public bssl::RefCounted<ssl_ctx_st> {
   // signal its sessions may be resumed across names in the server certificate.
   bool resumption_across_names_enabled : 1;
 
+  bssl::Array<uint8_t> cipher13_flag_list;
+  bssl::Array<uint8_t> extension_permutation;
  private:
   friend RefCounted;
   ~ssl_ctx_st();
diff --git a/ssl/ssl_cipher.cc b/ssl/ssl_cipher.cc
index 1ef231c39..0ed36d942 100644
--- a/ssl/ssl_cipher.cc
+++ b/ssl/ssl_cipher.cc
@@ -75,6 +75,64 @@ static constexpr SSL_CIPHER kCiphers[] = {
         SSL_HANDSHAKE_MAC_DEFAULT,
     },
 
+    // Cipher 39
+    {
+    TLS1_TXT_DHE_RSA_WITH_AES_256_SHA,
+    "TLS_DHE_RSA_WITH_AES_256_SHA",
+    TLS1_CK_DHE_RSA_WITH_AES_256_SHA,
+    SSL_kRSA,
+    SSL_aRSA_DECRYPT,
+    SSL_AES256,
+    SSL_SHA1,
+    SSL_HANDSHAKE_MAC_DEFAULT,
+    },
+
+        // Cipher 3C
+    {
+    TLS1_TXT_RSA_WITH_AES_128_SHA256,
+    "TLS_RSA_WITH_AES_128_SHA256",
+    TLS1_CK_RSA_WITH_AES_128_SHA256,
+    SSL_kRSA,
+    SSL_aRSA_DECRYPT,
+    SSL_AES256,
+    SSL_SHA1,
+    SSL_HANDSHAKE_MAC_DEFAULT,
+    },
+        // Cipher 3D
+    {
+    TLS1_TXT_RSA_WITH_AES_256_SHA256,
+    "TLS_RSA_WITH_AES_256_SHA256",
+    TLS1_CK_RSA_WITH_AES_256_SHA256,
+    SSL_kRSA,
+    SSL_aRSA_DECRYPT,
+    SSL_AES256,
+    SSL_SHA1,
+    SSL_HANDSHAKE_MAC_DEFAULT,
+    },
+
+        // Cipher 67
+    {
+    TLS1_TXT_DHE_RSA_WITH_AES_128_SHA256,
+    "TLS_DHE_RSA_WITH_AES_128_SHA256",
+    TLS1_CK_DHE_RSA_WITH_AES_128_SHA256,
+    SSL_kRSA,
+    SSL_aRSA_DECRYPT,
+    SSL_AES128,
+    SSL_SHA1,
+    SSL_HANDSHAKE_MAC_DEFAULT,
+    },
+
+        // Cipher 6B
+    {
+    TLS1_TXT_DHE_RSA_WITH_AES_256_SHA256,
+    "TLS_DHE_RSA_WITH_AES_256_SHA256",
+    TLS1_CK_DHE_RSA_WITH_AES_256_SHA256,
+    SSL_kRSA,
+    SSL_aRSA_DECRYPT,
+    SSL_AES256,
+    SSL_SHA1,
+    SSL_HANDSHAKE_MAC_DEFAULT,
+     },
     // PSK cipher suites.
 
     // Cipher 8C
@@ -125,8 +183,30 @@ static constexpr SSL_CIPHER kCiphers[] = {
         SSL_AES256GCM,
         SSL_AEAD,
         SSL_HANDSHAKE_MAC_SHA384,
+    },
+        // Cipher 9E
+    {
+    TLS1_TXT_DHE_RSA_WITH_AES_128_GCM_SHA256,
+    "TLS_DHE_RSA_WITH_AES_128_GCM_SHA256",
+    TLS1_CK_DHE_RSA_WITH_AES_128_GCM_SHA256,
+    SSL_kECDHE,
+    SSL_aGENERIC,
+    SSL_AES128GCM,
+    SSL_AEAD,
+    SSL_HANDSHAKE_MAC_SHA256,
     },
 
+    // Cipher 9F
+    {
+    TLS1_TXT_DHE_RSA_WITH_AES_256_GCM_SHA384,
+    "TLS_DHE_RSA_WITH_AES_256_GCM_SHA384",
+    TLS1_CK_DHE_RSA_WITH_AES_256_GCM_SHA384,
+    SSL_kECDHE,
+    SSL_aGENERIC,
+    SSL_AES256GCM,
+    SSL_AEAD,
+    SSL_HANDSHAKE_MAC_SHA384,
+    },
     // TLS 1.3 suites.
 
     // Cipher 1301
@@ -165,6 +245,17 @@ static constexpr SSL_CIPHER kCiphers[] = {
         SSL_HANDSHAKE_MAC_SHA256,
     },
 
+    // Cipher C008
+    {
+    "ECDHE-ECDSA-DES-CBC3-SHA",
+    "TLS_ECDHE_ECDSA_WITH_3DES_EDE_CBC_SHA",
+    0x0300C008,
+    SSL_kECDHE,
+    SSL_aECDSA,
+    SSL_3DES,
+    SSL_SHA1,
+    SSL_HANDSHAKE_MAC_DEFAULT,
+    },
     // Cipher C009
     {
         TLS1_TXT_ECDHE_ECDSA_WITH_AES_128_CBC_SHA,
@@ -189,6 +280,17 @@ static constexpr SSL_CIPHER kCiphers[] = {
         SSL_HANDSHAKE_MAC_DEFAULT,
     },
 
+    // Cipher C012
+    {
+    "ECDHE-RSA-DES-CBC3-SHA",
+    "TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA",
+    0x0300C012,
+    SSL_kECDHE,
+    SSL_aRSA_DECRYPT,
+    SSL_3DES,
+    SSL_SHA1,
+    SSL_HANDSHAKE_MAC_DEFAULT,
+     },
     // Cipher C013
     {
         TLS1_TXT_ECDHE_RSA_WITH_AES_128_CBC_SHA,
@@ -228,6 +330,38 @@ static constexpr SSL_CIPHER kCiphers[] = {
     },
 
     // Cipher C027 (deprecated)
+       // curl-impersonate: Ciphers C023, C024, C027, C028 were removed in
+      // https://boringssl-review.googlesource.com/c/boringssl/+/27944/
+              // but restored here to impersonate browsers with older ciphers. They
+              // are
+              // not expected to actually work; but just to be included in the TLS
+              // Client Hello.
+              // HMAC based TLS v1.2 ciphersuites from RFC5289
+              // Cipher C023
+    {
+    TLS1_TXT_ECDHE_ECDSA_WITH_AES_128_SHA256,
+    "TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256",
+    TLS1_CK_ECDHE_ECDSA_WITH_AES_128_SHA256,
+    SSL_kECDHE,
+    SSL_aECDSA,
+    SSL_AES128,
+    SSL_SHA256,
+    SSL_HANDSHAKE_MAC_SHA256,
+    },
+
+    // Cipher C024
+
+    {
+    TLS1_TXT_ECDHE_ECDSA_WITH_AES_256_SHA384,
+    "TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384",
+    TLS1_CK_ECDHE_ECDSA_WITH_AES_256_SHA384,
+    SSL_kECDHE,
+    SSL_aECDSA,
+    SSL_AES256,
+    SSL_SHA384,
+    SSL_HANDSHAKE_MAC_SHA384,
+    },
+    // Cipher C027
     {
         TLS1_TXT_ECDHE_RSA_WITH_AES_128_CBC_SHA256,
         "TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256",
@@ -238,6 +372,17 @@ static constexpr SSL_CIPHER kCiphers[] = {
         SSL_SHA256,
         SSL_HANDSHAKE_MAC_SHA256,
     },
+    // Cipher C028
+    {
+    TLS1_TXT_ECDHE_RSA_WITH_AES_256_SHA384,
+    "TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384",
+    TLS1_CK_ECDHE_RSA_WITH_AES_256_SHA384,
+    SSL_kECDHE,
+    SSL_aRSA_DECRYPT,
+    SSL_AES256,
+    SSL_SHA384,
+    SSL_HANDSHAKE_MAC_SHA384,
+    },
 
     // GCM based TLS v1.2 ciphersuites from RFC 5289
 
@@ -357,15 +502,15 @@ static constexpr SSL_CIPHER kCiphers[] = {
 
 Span<const SSL_CIPHER> AllCiphers() { return kCiphers; }
 
-static constexpr size_t NumTLS13Ciphers() {
-  size_t num = 0;
-  for (const auto &cipher : kCiphers) {
-    if (cipher.algorithm_mkey == SSL_kGENERIC) {
-      num++;
-    }
-  }
-  return num;
-}
+//static constexpr size_t NumTLS13Ciphers() {
+//  size_t num = 0;
+//  for (const auto &cipher : kCiphers) {
+//    if (cipher.algorithm_mkey == SSL_kGENERIC) {
+//      num++;
+//    }
+//  }
+//  return num;
+//}
 
 #define CIPHER_ADD 1
 #define CIPHER_KILL 2
@@ -454,6 +599,14 @@ static const CIPHER_ALIAS kCipherAliases[] = {
     // Legacy strength classes.
     {"HIGH", ~0u, ~0u, ~0u, ~0u, 0},
     {"FIPS", ~0u, ~0u, ~0u, ~0u, 0},
+
+    // Temporary no-op aliases corresponding to removed SHA-2 legacy CBC
+    // ciphers. These should be removed after 2018-05-14.
+    /*{"SHA256", 0, 0, 0, 0, 0},
+    {"SHA384", 0, 0, 0, 0, 0},*/
+
+    {"SHA256", ~0u, ~0u, ~0u, SSL_SHA256, 0},
+    {"SHA384", ~0u, ~0u, ~0u, SSL_SHA384, 0},
 };
 
 static const size_t kCipherAliasesLen = std::size(kCipherAliases);
@@ -1085,9 +1238,10 @@ bool ssl_create_cipher_list(UniquePtr<SSLCipherPreferenceList> *out_cipher_list,
     co_list[num++].cipher = SSL_get_cipher_by_value(id);
     assert(co_list[num - 1].cipher != nullptr);
   }
-  assert(num == std::size(co_list));
-  static_assert(std::size(co_list) + NumTLS13Ciphers() == std::size(kCiphers),
-                "Not all ciphers are included in the cipher order");
+  assert(num == OPENSSL_ARRAY_SIZE(co_list));
+  /*static_assert(OPENSSL_ARRAY_SIZE(co_list) + NumTLS13Ciphers() ==
+                    OPENSSL_ARRAY_SIZE(kCiphers),
+                "Not all ciphers are included in the cipher order");*/
 
   // If the rule_string begins with DEFAULT, apply the default rule before
   // using the (possibly available) additional rules.
diff --git a/ssl/ssl_key_share.cc b/ssl/ssl_key_share.cc
index d155b5527..dbb4db9d4 100644
--- a/ssl/ssl_key_share.cc
+++ b/ssl/ssl_key_share.cc
@@ -444,6 +444,10 @@ constexpr NamedGroup kNamedGroups[] = {
      "X25519Kyber768Draft00", ""},
     {NID_X25519MLKEM768, SSL_GROUP_X25519_MLKEM768, "X25519MLKEM768", ""},
     {NID_ML_KEM_1024, SSL_GROUP_MLKEM1024, "MLKEM1024", ""},
+
+    //unspport group but add them
+    {NID_secp224r1, 256, "dhe2048", "ffdhe2048"},
+    {NID_secp224r1, 257, "dhe3072", "ffdhe3072"},
 };
 
 static_assert(std::size(kNamedGroups) == kNumNamedGroups,
diff --git a/ssl/ssl_lib.cc b/ssl/ssl_lib.cc
index a1ba926fd..871fee633 100644
--- a/ssl/ssl_lib.cc
+++ b/ssl/ssl_lib.cc
@@ -559,6 +559,13 @@ SSL *SSL_new(SSL_CTX *ctx) {
   ssl->config->ocsp_stapling_enabled = ctx->ocsp_stapling_enabled;
   ssl->config->handoff = ctx->handoff;
   ssl->quic_method = ctx->quic_method;
+  SSL_enable_ocsp_stapling(ssl.get());
+  SSL_add_application_settings(ssl.get(),
+      reinterpret_cast<const uint8_t*>("h2"),
+      2, NULL, 0);
+  SSL_CTX_set_grease_enabled(ssl->ctx.get(), 1);
+  SSL_enable_signed_cert_timestamps(ssl.get());
+  SSL_set_enable_ech_grease(ssl.get(), 1);
 
   if (!ssl->method->ssl_new(ssl.get()) ||
       !ssl->ctx->x509_method->ssl_new(ssl->s3->hs.get())) {
@@ -3469,7 +3476,7 @@ static int Configure(SSL_CTX *ctx) {
 }
 
 static int Configure(SSL *ssl) {
-  ssl->config->compliance_policy = ssl_compliance_policy_wpa3_192_202304;
+  ssl->config->tls13_cipher_policy = ssl_compliance_policy_wpa3_192_202304;
 
   return SSL_set_min_proto_version(ssl, TLS1_2_VERSION) &&
          SSL_set_max_proto_version(ssl, TLS1_3_VERSION) &&
@@ -3526,6 +3533,36 @@ int SSL_set_compliance_policy(SSL *ssl, enum ssl_compliance_policy_t policy) {
   }
 }
 
+int SSL_CTX_set_ciphersuites(SSL_CTX *ctx, char *str) {
+  if (!str) {
+    return 0;
+  }
+  bssl::Array<uint8_t> arr;
+  arr.Init(strlen(str));
+  int i = 0;
+  const char *l = str;
+  do {
+    arr[i++] = *l;
+  } while (*++l != '\0');
+  ctx->cipher13_flag_list = std::move(arr);
+  return ctx->cipher13_flag_list.empty() ? 0 : 1;
+}
+
+int SSL_CTX_set_extension_permutation(SSL_CTX *ctx, char *str) {
+  if (!str) {
+    return 0;
+  }
+  bssl::Array<uint8_t> arr;
+  arr.Init(strlen(str));
+  int i = 0;
+  const char *l = str;
+  do {
+    arr[i++] = *l - 1;
+  } while (*++l != '\0');
+  ctx->extension_permutation = std::move(arr);
+  return ctx->extension_permutation.empty() ? 0 : 1;
+}
+
 enum ssl_compliance_policy_t SSL_get_compliance_policy(const SSL *ssl) {
   return ssl->config->compliance_policy;
 }
diff --git a/tool/server.cc b/tool/server.cc
index 69db15b24..a1ded09ad 100644
--- a/tool/server.cc
+++ b/tool/server.cc
@@ -263,7 +263,7 @@ bool Server(const std::vector<std::string> &args) {
   }
 
   bssl::UniquePtr<SSL_CTX> ctx(SSL_CTX_new(TLS_method()));
-
+  SSL_CTX_set_permute_extensions(ctx.get(), 1);
   const char *keylog_file = getenv("SSLKEYLOGFILE");
   if (keylog_file) {
     g_keylog_file = fopen(keylog_file, "a");
-- 
2.36.1.windows.1


From 931c79ee3398465922c605758be53fcb90a4e016 Mon Sep 17 00:00:00 2001
From: Ossian <857984597@qq.com>
Date: Fri, 13 Feb 2026 09:12:15 +0800
Subject: [PATCH 2/3] patch

---
 include/openssl/tls1.h  | 357 +++++++++++++++++++++++++++++++++++-----
 ssl/extensions.cc       |  27 ++-
 ssl/handshake_client.cc |  16 +-
 ssl/ssl_cipher.cc       |  28 ++--
 ssl/ssl_key_share.cc    |   4 +-
 ssl/ssl_lib.cc          |   6 +-
 6 files changed, 357 insertions(+), 81 deletions(-)

diff --git a/include/openssl/tls1.h b/include/openssl/tls1.h
index 7e6aa1923..fcd435045 100644
--- a/include/openssl/tls1.h
+++ b/include/openssl/tls1.h
@@ -48,8 +48,7 @@ extern "C" {
 #define TLS1_AD_NO_APPLICATION_PROTOCOL 120
 #define TLS1_AD_ECH_REQUIRED 121  // draft-ietf-tls-esni-13
 
-#define TLSEXT_TYPE_record_size_limit 28
-// ExtensionType values from RFC 6066
+	// ExtensionType values from RFC 6066
 #define TLSEXT_TYPE_server_name 0
 #define TLSEXT_TYPE_status_request 5
 
@@ -120,10 +119,6 @@ extern "C" {
 #define TLSEXT_TYPE_encrypted_client_hello 0xfe0d
 #define TLSEXT_TYPE_ech_outer_extensions 0xfd00
 
-// ExtensionType values from draft-bmw-tls-pake13. This is not an IANA defined
-// extension number.
-#define TLSEXT_TYPE_pake 0x8a3b
-
 // ExtensionType value from RFC 6962
 #define TLSEXT_TYPE_certificate_timestamp 18
 
@@ -133,14 +128,6 @@ extern "C" {
 // This is not an IANA defined extension number
 #define TLSEXT_TYPE_channel_id 30032
 
-// This is not an IANA defined extension number
-// TODO(crbug.com/398275713): Replace with the final codepoint once
-// standardization completes.
-#define TLSEXT_TYPE_trust_anchors 0xca34
-
-// ExtensionType value from draft-ietf-tls-tlsflags.
-#define TLSEXT_TYPE_tls_flags 62
-
 // status request value from RFC 3546
 #define TLSEXT_STATUSTYPE_nothing (-1)
 #define TLSEXT_STATUSTYPE_ocsp 1
@@ -170,33 +157,171 @@ extern "C" {
 
 #define TLSEXT_MAXLEN_host_name 255
 
-// The following constants are equal to TLS cipher suite values, OR-d with
-// 0x03000000. This is part of OpenSSL's SSL 2.0 legacy. SSL 2.0 has long since
-// been removed from BoringSSL.
-// TODO(davidben): Define these in terms of |SSL_CIPHER_*| constants. The
-// challenge is that existing code expects them to be defined in tls1.h, so we
-// must first merge tls1.h into ssl.h.
-#define TLS1_CK_PSK_WITH_AES_128_CBC_SHA 0x0300008C
-#define TLS1_CK_PSK_WITH_AES_256_CBC_SHA 0x0300008D
-#define TLS1_CK_ECDHE_PSK_WITH_AES_128_CBC_SHA 0x0300C035
-#define TLS1_CK_ECDHE_PSK_WITH_AES_256_CBC_SHA 0x0300C036
+// PSK ciphersuites from 4279
+#define TLS1_CK_PSK_WITH_RC4_128_SHA                    0x0300008A
+#define TLS1_CK_PSK_WITH_3DES_EDE_CBC_SHA               0x0300008B
+#define TLS1_CK_PSK_WITH_AES_128_CBC_SHA                0x0300008C
+#define TLS1_CK_PSK_WITH_AES_256_CBC_SHA                0x0300008D
+
+// PSK ciphersuites from RFC 5489
+#define TLS1_CK_ECDHE_PSK_WITH_AES_128_CBC_SHA          0x0300C035
+#define TLS1_CK_ECDHE_PSK_WITH_AES_256_CBC_SHA          0x0300C036
+
+// Additional TLS ciphersuites from expired Internet Draft
+// draft-ietf-tls-56-bit-ciphersuites-01.txt
+// (available if TLS1_ALLOW_EXPERIMENTAL_CIPHERSUITES is defined, see
+// s3_lib.c).  We actually treat them like SSL 3.0 ciphers, which we probably
+// shouldn't.  Note that the first two are actually not in the IDs.
+#define TLS1_CK_RSA_EXPORT1024_WITH_RC4_56_MD5 0x03000060      // not in ID
+#define TLS1_CK_RSA_EXPORT1024_WITH_RC2_CBC_56_MD5 0x03000061  // not in ID
+#define TLS1_CK_RSA_EXPORT1024_WITH_DES_CBC_SHA 0x03000062
+#define TLS1_CK_DHE_DSS_EXPORT1024_WITH_DES_CBC_SHA 0x03000063
+#define TLS1_CK_RSA_EXPORT1024_WITH_RC4_56_SHA 0x03000064
+#define TLS1_CK_DHE_DSS_EXPORT1024_WITH_RC4_56_SHA 0x03000065
+#define TLS1_CK_DHE_DSS_WITH_RC4_128_SHA 0x03000066
+
+// AES ciphersuites from RFC 3268
+
 #define TLS1_CK_RSA_WITH_AES_128_SHA 0x0300002F
-#define TLS1_CK_RSA_WITH_AES_256_SHA 0x03000035
-#define TLS1_CK_RSA_WITH_AES_128_GCM_SHA256 0x0300009C
-#define TLS1_CK_RSA_WITH_AES_256_GCM_SHA384 0x0300009D
+#define TLS1_CK_DH_DSS_WITH_AES_128_SHA 0x03000030
+#define TLS1_CK_DH_RSA_WITH_AES_128_SHA 0x03000031
+#define TLS1_CK_DHE_DSS_WITH_AES_128_SHA 0x03000032
+#define TLS1_CK_DHE_RSA_WITH_AES_128_SHA 0x03000033
+#define TLS1_CK_ADH_WITH_AES_128_SHA 0x03000034
+
+#define TLS1_CK_RSA_WITH_AES_256_SHA 0x00000035
+#define TLS1_CK_DH_DSS_WITH_AES_256_SHA 0x00000036
+#define TLS1_CK_DH_RSA_WITH_AES_256_SHA 0x00000037
+#define TLS1_CK_DHE_DSS_WITH_AES_256_SHA 0x00000038
+#define TLS1_CK_DHE_RSA_WITH_AES_256_SHA 0x00000039
+#define TLS1_CK_ADH_WITH_AES_256_SHA 0x0000003A
+
+// TLS v1.2 ciphersuites
+#define TLS1_CK_RSA_WITH_NULL_SHA256 0x0000003B
+#define TLS1_CK_RSA_WITH_AES_128_SHA256 0x0000003C
+#define TLS1_CK_RSA_WITH_AES_256_SHA256 0x0000003D
+#define TLS1_CK_DH_DSS_WITH_AES_128_SHA256 0x0000003E
+#define TLS1_CK_DH_RSA_WITH_AES_128_SHA256 0x0000003F
+#define TLS1_CK_DHE_DSS_WITH_AES_128_SHA256 0x00000040
+
+// Camellia ciphersuites from RFC 4132
+#define TLS1_CK_RSA_WITH_CAMELLIA_128_CBC_SHA 0x03000041
+#define TLS1_CK_DH_DSS_WITH_CAMELLIA_128_CBC_SHA 0x03000042
+#define TLS1_CK_DH_RSA_WITH_CAMELLIA_128_CBC_SHA 0x03000043
+#define TLS1_CK_DHE_DSS_WITH_CAMELLIA_128_CBC_SHA 0x03000044
+#define TLS1_CK_DHE_RSA_WITH_CAMELLIA_128_CBC_SHA 0x03000045
+#define TLS1_CK_ADH_WITH_CAMELLIA_128_CBC_SHA 0x03000046
+
+// TLS v1.2 ciphersuites
+#define TLS1_CK_DHE_RSA_WITH_AES_128_SHA256 0x00000067
+#define TLS1_CK_DH_DSS_WITH_AES_256_SHA256 0x00000068
+#define TLS1_CK_DH_RSA_WITH_AES_256_SHA256 0x00000069
+#define TLS1_CK_DHE_DSS_WITH_AES_256_SHA256 0x0000006A
+#define TLS1_CK_DHE_RSA_WITH_AES_256_SHA256 0x0000006B
+#define TLS1_CK_ADH_WITH_AES_128_SHA256 0x0000006C
+#define TLS1_CK_ADH_WITH_AES_256_SHA256 0x0000006D
+
+// Camellia ciphersuites from RFC 4132
+#define TLS1_CK_RSA_WITH_CAMELLIA_256_CBC_SHA 0x03000084
+#define TLS1_CK_DH_DSS_WITH_CAMELLIA_256_CBC_SHA 0x03000085
+#define TLS1_CK_DH_RSA_WITH_CAMELLIA_256_CBC_SHA 0x03000086
+#define TLS1_CK_DHE_DSS_WITH_CAMELLIA_256_CBC_SHA 0x03000087
+#define TLS1_CK_DHE_RSA_WITH_CAMELLIA_256_CBC_SHA 0x03000088
+#define TLS1_CK_ADH_WITH_CAMELLIA_256_CBC_SHA 0x03000089
+
+// SEED ciphersuites from RFC 4162
+#define TLS1_CK_RSA_WITH_SEED_SHA 0x03000096
+#define TLS1_CK_DH_DSS_WITH_SEED_SHA 0x03000097
+#define TLS1_CK_DH_RSA_WITH_SEED_SHA 0x03000098
+#define TLS1_CK_DHE_DSS_WITH_SEED_SHA 0x03000099
+#define TLS1_CK_DHE_RSA_WITH_SEED_SHA 0x0300009A
+#define TLS1_CK_ADH_WITH_SEED_SHA 0x0300009B
+
+// TLS v1.2 GCM ciphersuites from RFC 5288
+#define TLS1_CK_RSA_WITH_AES_128_GCM_SHA256 0x0000009C
+#define TLS1_CK_RSA_WITH_AES_256_GCM_SHA384 0x0000009D
+#define TLS1_CK_DHE_RSA_WITH_AES_128_GCM_SHA256 0x0000009E
+#define TLS1_CK_DHE_RSA_WITH_AES_256_GCM_SHA384 0x0000009F
+#define TLS1_CK_DH_RSA_WITH_AES_128_GCM_SHA256 0x000000A0
+#define TLS1_CK_DH_RSA_WITH_AES_256_GCM_SHA384 0x000000A1
+#define TLS1_CK_DHE_DSS_WITH_AES_128_GCM_SHA256 0x000000A2
+#define TLS1_CK_DHE_DSS_WITH_AES_256_GCM_SHA384 0x000000A3
+#define TLS1_CK_DH_DSS_WITH_AES_128_GCM_SHA256 0x000000A4
+#define TLS1_CK_DH_DSS_WITH_AES_256_GCM_SHA384 0x000000A5
+#define TLS1_CK_ADH_WITH_AES_128_GCM_SHA256 0x000000A6
+#define TLS1_CK_ADH_WITH_AES_256_GCM_SHA384 0x000000A7
+
+// ECC ciphersuites from RFC 4492
+#define TLS1_CK_ECDH_ECDSA_WITH_NULL_SHA 0x0300C001
+#define TLS1_CK_ECDH_ECDSA_WITH_RC4_128_SHA 0x0300C002
+#define TLS1_CK_ECDH_ECDSA_WITH_DES_192_CBC3_SHA 0x0300C003
+#define TLS1_CK_ECDH_ECDSA_WITH_AES_128_CBC_SHA 0x0300C004
+#define TLS1_CK_ECDH_ECDSA_WITH_AES_256_CBC_SHA 0x0300C005
+
+#define TLS1_CK_ECDHE_ECDSA_WITH_NULL_SHA 0x0300C006
+#define TLS1_CK_ECDHE_ECDSA_WITH_RC4_128_SHA 0x0300C007
+#define TLS1_CK_ECDHE_ECDSA_WITH_DES_192_CBC3_SHA 0x0300C008
 #define TLS1_CK_ECDHE_ECDSA_WITH_AES_128_CBC_SHA 0x0300C009
 #define TLS1_CK_ECDHE_ECDSA_WITH_AES_256_CBC_SHA 0x0300C00A
+
+#define TLS1_CK_ECDH_RSA_WITH_NULL_SHA 0x0300C00B
+#define TLS1_CK_ECDH_RSA_WITH_RC4_128_SHA 0x0300C00C
+#define TLS1_CK_ECDH_RSA_WITH_DES_192_CBC3_SHA 0x0300C00D
+#define TLS1_CK_ECDH_RSA_WITH_AES_128_CBC_SHA 0x0300C00E
+#define TLS1_CK_ECDH_RSA_WITH_AES_256_CBC_SHA 0x0300C00F
+
+#define TLS1_CK_ECDHE_RSA_WITH_NULL_SHA 0x0300C010
+#define TLS1_CK_ECDHE_RSA_WITH_RC4_128_SHA 0x0300C011
+#define TLS1_CK_ECDHE_RSA_WITH_DES_192_CBC3_SHA 0x0300C012
 #define TLS1_CK_ECDHE_RSA_WITH_AES_128_CBC_SHA 0x0300C013
 #define TLS1_CK_ECDHE_RSA_WITH_AES_256_CBC_SHA 0x0300C014
-#define TLS1_CK_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256 0x0300C023
+
 #define TLS1_CK_ECDHE_RSA_WITH_AES_128_CBC_SHA256 0x0300C027
+
+#define TLS1_CK_ECDH_anon_WITH_NULL_SHA 0x0300C015
+#define TLS1_CK_ECDH_anon_WITH_RC4_128_SHA 0x0300C016
+#define TLS1_CK_ECDH_anon_WITH_DES_192_CBC3_SHA 0x0300C017
+#define TLS1_CK_ECDH_anon_WITH_AES_128_CBC_SHA 0x0300C018
+#define TLS1_CK_ECDH_anon_WITH_AES_256_CBC_SHA 0x0300C019
+
+// SRP ciphersuites from RFC 5054
+#define TLS1_CK_SRP_SHA_WITH_3DES_EDE_CBC_SHA 0x0300C01A
+#define TLS1_CK_SRP_SHA_RSA_WITH_3DES_EDE_CBC_SHA 0x0300C01B
+#define TLS1_CK_SRP_SHA_DSS_WITH_3DES_EDE_CBC_SHA 0x0300C01C
+#define TLS1_CK_SRP_SHA_WITH_AES_128_CBC_SHA 0x0300C01D
+#define TLS1_CK_SRP_SHA_RSA_WITH_AES_128_CBC_SHA 0x0300C01E
+#define TLS1_CK_SRP_SHA_DSS_WITH_AES_128_CBC_SHA 0x0300C01F
+#define TLS1_CK_SRP_SHA_WITH_AES_256_CBC_SHA 0x0300C020
+#define TLS1_CK_SRP_SHA_RSA_WITH_AES_256_CBC_SHA 0x0300C021
+#define TLS1_CK_SRP_SHA_DSS_WITH_AES_256_CBC_SHA 0x0300C022
+
+// ECDH HMAC based ciphersuites from RFC 5289
+
+#define TLS1_CK_ECDHE_ECDSA_WITH_AES_128_SHA256 0x0000C023
+#define TLS1_CK_ECDHE_ECDSA_WITH_AES_256_SHA384 0x0000C024
+#define TLS1_CK_ECDH_ECDSA_WITH_AES_128_SHA256 0x0000C025
+#define TLS1_CK_ECDH_ECDSA_WITH_AES_256_SHA384 0x0000C026
+#define TLS1_CK_ECDHE_RSA_WITH_AES_128_SHA256 0x0000C027
+#define TLS1_CK_ECDHE_RSA_WITH_AES_256_SHA384 0x0000C028
+#define TLS1_CK_ECDH_RSA_WITH_AES_128_SHA256 0x0000C029
+#define TLS1_CK_ECDH_RSA_WITH_AES_256_SHA384 0x0000C02A
+
+// ECDH GCM based ciphersuites from RFC 5289
 #define TLS1_CK_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256 0x0300C02B
 #define TLS1_CK_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384 0x0300C02C
+#define TLS1_CK_ECDH_ECDSA_WITH_AES_128_GCM_SHA256 0x0300C02D
+#define TLS1_CK_ECDH_ECDSA_WITH_AES_256_GCM_SHA384 0x0300C02E
 #define TLS1_CK_ECDHE_RSA_WITH_AES_128_GCM_SHA256 0x0300C02F
 #define TLS1_CK_ECDHE_RSA_WITH_AES_256_GCM_SHA384 0x0300C030
+#define TLS1_CK_ECDH_RSA_WITH_AES_128_GCM_SHA256 0x0300C031
+#define TLS1_CK_ECDH_RSA_WITH_AES_256_GCM_SHA384 0x0300C032
+
+// ChaCha20-Poly1305 cipher suites from RFC 7905.
 #define TLS1_CK_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256 0x0300CCA8
 #define TLS1_CK_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256 0x0300CCA9
 #define TLS1_CK_ECDHE_PSK_WITH_CHACHA20_POLY1305_SHA256 0x0300CCAC
+
+// TLS 1.3 ciphersuites from RFC 8446.
 #define TLS1_3_CK_AES_128_GCM_SHA256 0x03001301
 #define TLS1_3_CK_AES_256_GCM_SHA384 0x03001302
 #define TLS1_3_CK_CHACHA20_POLY1305_SHA256 0x03001303
@@ -207,39 +332,186 @@ extern "C" {
 #define TLS1_CK_AES_256_GCM_SHA384 TLS1_3_CK_AES_256_GCM_SHA384
 #define TLS1_CK_CHACHA20_POLY1305_SHA256 TLS1_3_CK_CHACHA20_POLY1305_SHA256
 
-// The following constants are the OpenSSL names (see |SSL_CIPHER_get_name|) for
-// various TLS ciphers. Prefer the standard name, returned from
-// |SSL_CIPHER_standard_name| and supported by |SSL_CTX_set_cipher_list|.
-#define TLS1_TXT_PSK_WITH_AES_128_CBC_SHA "PSK-AES128-CBC-SHA"
-#define TLS1_TXT_PSK_WITH_AES_256_CBC_SHA "PSK-AES256-CBC-SHA"
-#define TLS1_TXT_ECDHE_PSK_WITH_AES_128_CBC_SHA "ECDHE-PSK-AES128-CBC-SHA"
-#define TLS1_TXT_ECDHE_PSK_WITH_AES_256_CBC_SHA "ECDHE-PSK-AES256-CBC-SHA"
+// XXX
+// Inconsistency alert:
+// The OpenSSL names of ciphers with ephemeral DH here include the string
+// "DHE", while elsewhere it has always been "EDH".
+// (The alias for the list of all such ciphers also is "EDH".)
+// The specifications speak of "EDH"; maybe we should allow both forms
+// for everything.
+#define TLS1_TXT_RSA_EXPORT1024_WITH_RC4_56_MD5 "EXP1024-RC4-MD5"
+#define TLS1_TXT_RSA_EXPORT1024_WITH_RC2_CBC_56_MD5 "EXP1024-RC2-CBC-MD5"
+#define TLS1_TXT_RSA_EXPORT1024_WITH_DES_CBC_SHA "EXP1024-DES-CBC-SHA"
+#define TLS1_TXT_DHE_DSS_EXPORT1024_WITH_DES_CBC_SHA \
+  "EXP1024-DHE-DSS-DES-CBC-SHA"
+#define TLS1_TXT_RSA_EXPORT1024_WITH_RC4_56_SHA "EXP1024-RC4-SHA"
+#define TLS1_TXT_DHE_DSS_EXPORT1024_WITH_RC4_56_SHA "EXP1024-DHE-DSS-RC4-SHA"
+#define TLS1_TXT_DHE_DSS_WITH_RC4_128_SHA "DHE-DSS-RC4-SHA"
+
+// AES ciphersuites from RFC 3268
 #define TLS1_TXT_RSA_WITH_AES_128_SHA "AES128-SHA"
+#define TLS1_TXT_DH_DSS_WITH_AES_128_SHA "DH-DSS-AES128-SHA"
+#define TLS1_TXT_DH_RSA_WITH_AES_128_SHA "DH-RSA-AES128-SHA"
+#define TLS1_TXT_DHE_DSS_WITH_AES_128_SHA "DHE-DSS-AES128-SHA"
+#define TLS1_TXT_DHE_RSA_WITH_AES_128_SHA "DHE-RSA-AES128-SHA"
+#define TLS1_TXT_ADH_WITH_AES_128_SHA "ADH-AES128-SHA"
+
 #define TLS1_TXT_RSA_WITH_AES_256_SHA "AES256-SHA"
-#define TLS1_TXT_RSA_WITH_AES_128_GCM_SHA256 "AES128-GCM-SHA256"
-#define TLS1_TXT_RSA_WITH_AES_256_GCM_SHA384 "AES256-GCM-SHA384"
+#define TLS1_TXT_DH_DSS_WITH_AES_256_SHA "DH-DSS-AES256-SHA"
+#define TLS1_TXT_DH_RSA_WITH_AES_256_SHA "DH-RSA-AES256-SHA"
+#define TLS1_TXT_DHE_DSS_WITH_AES_256_SHA "DHE-DSS-AES256-SHA"
+#define TLS1_TXT_DHE_RSA_WITH_AES_256_SHA "DHE-RSA-AES256-SHA"
+#define TLS1_TXT_ADH_WITH_AES_256_SHA "ADH-AES256-SHA"
+
+// ECC ciphersuites from RFC 4492
+#define TLS1_TXT_ECDH_ECDSA_WITH_NULL_SHA "ECDH-ECDSA-NULL-SHA"
+#define TLS1_TXT_ECDH_ECDSA_WITH_RC4_128_SHA "ECDH-ECDSA-RC4-SHA"
+#define TLS1_TXT_ECDH_ECDSA_WITH_DES_192_CBC3_SHA "ECDH-ECDSA-DES-CBC3-SHA"
+#define TLS1_TXT_ECDH_ECDSA_WITH_AES_128_CBC_SHA "ECDH-ECDSA-AES128-SHA"
+#define TLS1_TXT_ECDH_ECDSA_WITH_AES_256_CBC_SHA "ECDH-ECDSA-AES256-SHA"
+
+#define TLS1_TXT_ECDHE_ECDSA_WITH_NULL_SHA "ECDHE-ECDSA-NULL-SHA"
+#define TLS1_TXT_ECDHE_ECDSA_WITH_RC4_128_SHA "ECDHE-ECDSA-RC4-SHA"
+#define TLS1_TXT_ECDHE_ECDSA_WITH_DES_192_CBC3_SHA "ECDHE-ECDSA-DES-CBC3-SHA"
 #define TLS1_TXT_ECDHE_ECDSA_WITH_AES_128_CBC_SHA "ECDHE-ECDSA-AES128-SHA"
 #define TLS1_TXT_ECDHE_ECDSA_WITH_AES_256_CBC_SHA "ECDHE-ECDSA-AES256-SHA"
+
+#define TLS1_TXT_ECDH_RSA_WITH_NULL_SHA "ECDH-RSA-NULL-SHA"
+#define TLS1_TXT_ECDH_RSA_WITH_RC4_128_SHA "ECDH-RSA-RC4-SHA"
+#define TLS1_TXT_ECDH_RSA_WITH_DES_192_CBC3_SHA "ECDH-RSA-DES-CBC3-SHA"
+#define TLS1_TXT_ECDH_RSA_WITH_AES_128_CBC_SHA "ECDH-RSA-AES128-SHA"
+#define TLS1_TXT_ECDH_RSA_WITH_AES_256_CBC_SHA "ECDH-RSA-AES256-SHA"
+
+#define TLS1_TXT_ECDHE_RSA_WITH_NULL_SHA "ECDHE-RSA-NULL-SHA"
+#define TLS1_TXT_ECDHE_RSA_WITH_RC4_128_SHA "ECDHE-RSA-RC4-SHA"
+#define TLS1_TXT_ECDHE_RSA_WITH_DES_192_CBC3_SHA "ECDHE-RSA-DES-CBC3-SHA"
 #define TLS1_TXT_ECDHE_RSA_WITH_AES_128_CBC_SHA "ECDHE-RSA-AES128-SHA"
 #define TLS1_TXT_ECDHE_RSA_WITH_AES_256_CBC_SHA "ECDHE-RSA-AES256-SHA"
 #define TLS1_TXT_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256 "ECDHE-ECDSA-AES128-SHA256"
 #define TLS1_TXT_ECDHE_RSA_WITH_AES_128_CBC_SHA256 "ECDHE-RSA-AES128-SHA256"
+
+#define TLS1_TXT_ECDH_anon_WITH_NULL_SHA "AECDH-NULL-SHA"
+#define TLS1_TXT_ECDH_anon_WITH_RC4_128_SHA "AECDH-RC4-SHA"
+#define TLS1_TXT_ECDH_anon_WITH_DES_192_CBC3_SHA "AECDH-DES-CBC3-SHA"
+#define TLS1_TXT_ECDH_anon_WITH_AES_128_CBC_SHA "AECDH-AES128-SHA"
+#define TLS1_TXT_ECDH_anon_WITH_AES_256_CBC_SHA "AECDH-AES256-SHA"
+
+// PSK ciphersuites from RFC 4279
+#define TLS1_TXT_PSK_WITH_RC4_128_SHA "PSK-RC4-SHA"
+#define TLS1_TXT_PSK_WITH_3DES_EDE_CBC_SHA "PSK-3DES-EDE-CBC-SHA"
+#define TLS1_TXT_PSK_WITH_AES_128_CBC_SHA "PSK-AES128-CBC-SHA"
+#define TLS1_TXT_PSK_WITH_AES_256_CBC_SHA "PSK-AES256-CBC-SHA"
+
+// PSK ciphersuites from RFC 5489
+#define TLS1_TXT_ECDHE_PSK_WITH_AES_128_CBC_SHA "ECDHE-PSK-AES128-CBC-SHA"
+#define TLS1_TXT_ECDHE_PSK_WITH_AES_256_CBC_SHA "ECDHE-PSK-AES256-CBC-SHA"
+
+// SRP ciphersuite from RFC 5054
+#define TLS1_TXT_SRP_SHA_WITH_3DES_EDE_CBC_SHA "SRP-3DES-EDE-CBC-SHA"
+#define TLS1_TXT_SRP_SHA_RSA_WITH_3DES_EDE_CBC_SHA "SRP-RSA-3DES-EDE-CBC-SHA"
+#define TLS1_TXT_SRP_SHA_DSS_WITH_3DES_EDE_CBC_SHA "SRP-DSS-3DES-EDE-CBC-SHA"
+#define TLS1_TXT_SRP_SHA_WITH_AES_128_CBC_SHA "SRP-AES-128-CBC-SHA"
+#define TLS1_TXT_SRP_SHA_RSA_WITH_AES_128_CBC_SHA "SRP-RSA-AES-128-CBC-SHA"
+#define TLS1_TXT_SRP_SHA_DSS_WITH_AES_128_CBC_SHA "SRP-DSS-AES-128-CBC-SHA"
+#define TLS1_TXT_SRP_SHA_WITH_AES_256_CBC_SHA "SRP-AES-256-CBC-SHA"
+#define TLS1_TXT_SRP_SHA_RSA_WITH_AES_256_CBC_SHA "SRP-RSA-AES-256-CBC-SHA"
+#define TLS1_TXT_SRP_SHA_DSS_WITH_AES_256_CBC_SHA "SRP-DSS-AES-256-CBC-SHA"
+
+// Camellia ciphersuites from RFC 4132
+#define TLS1_TXT_RSA_WITH_CAMELLIA_128_CBC_SHA "CAMELLIA128-SHA"
+#define TLS1_TXT_DH_DSS_WITH_CAMELLIA_128_CBC_SHA "DH-DSS-CAMELLIA128-SHA"
+#define TLS1_TXT_DH_RSA_WITH_CAMELLIA_128_CBC_SHA "DH-RSA-CAMELLIA128-SHA"
+#define TLS1_TXT_DHE_DSS_WITH_CAMELLIA_128_CBC_SHA "DHE-DSS-CAMELLIA128-SHA"
+#define TLS1_TXT_DHE_RSA_WITH_CAMELLIA_128_CBC_SHA "DHE-RSA-CAMELLIA128-SHA"
+#define TLS1_TXT_ADH_WITH_CAMELLIA_128_CBC_SHA "ADH-CAMELLIA128-SHA"
+
+#define TLS1_TXT_RSA_WITH_CAMELLIA_256_CBC_SHA "CAMELLIA256-SHA"
+#define TLS1_TXT_DH_DSS_WITH_CAMELLIA_256_CBC_SHA "DH-DSS-CAMELLIA256-SHA"
+#define TLS1_TXT_DH_RSA_WITH_CAMELLIA_256_CBC_SHA "DH-RSA-CAMELLIA256-SHA"
+#define TLS1_TXT_DHE_DSS_WITH_CAMELLIA_256_CBC_SHA "DHE-DSS-CAMELLIA256-SHA"
+#define TLS1_TXT_DHE_RSA_WITH_CAMELLIA_256_CBC_SHA "DHE-RSA-CAMELLIA256-SHA"
+#define TLS1_TXT_ADH_WITH_CAMELLIA_256_CBC_SHA "ADH-CAMELLIA256-SHA"
+
+// SEED ciphersuites from RFC 4162
+#define TLS1_TXT_RSA_WITH_SEED_SHA "SEED-SHA"
+#define TLS1_TXT_DH_DSS_WITH_SEED_SHA "DH-DSS-SEED-SHA"
+#define TLS1_TXT_DH_RSA_WITH_SEED_SHA "DH-RSA-SEED-SHA"
+#define TLS1_TXT_DHE_DSS_WITH_SEED_SHA "DHE-DSS-SEED-SHA"
+#define TLS1_TXT_DHE_RSA_WITH_SEED_SHA "DHE-RSA-SEED-SHA"
+#define TLS1_TXT_ADH_WITH_SEED_SHA "ADH-SEED-SHA"
+
+// TLS v1.2 ciphersuites
+#define TLS1_TXT_RSA_WITH_NULL_SHA256 "NULL-SHA256"
+#define TLS1_TXT_RSA_WITH_AES_128_SHA256 "AES128-SHA256"
+#define TLS1_TXT_RSA_WITH_AES_256_SHA256 "AES256-SHA256"
+#define TLS1_TXT_DH_DSS_WITH_AES_128_SHA256 "DH-DSS-AES128-SHA256"
+#define TLS1_TXT_DH_RSA_WITH_AES_128_SHA256 "DH-RSA-AES128-SHA256"
+#define TLS1_TXT_DHE_DSS_WITH_AES_128_SHA256 "DHE-DSS-AES128-SHA256"
+#define TLS1_TXT_DHE_RSA_WITH_AES_128_SHA256 "DHE-RSA-AES128-SHA256"
+#define TLS1_TXT_DH_DSS_WITH_AES_256_SHA256 "DH-DSS-AES256-SHA256"
+#define TLS1_TXT_DH_RSA_WITH_AES_256_SHA256 "DH-RSA-AES256-SHA256"
+#define TLS1_TXT_DHE_DSS_WITH_AES_256_SHA256 "DHE-DSS-AES256-SHA256"
+#define TLS1_TXT_DHE_RSA_WITH_AES_256_SHA256 "DHE-RSA-AES256-SHA256"
+#define TLS1_TXT_ADH_WITH_AES_128_SHA256 "ADH-AES128-SHA256"
+#define TLS1_TXT_ADH_WITH_AES_256_SHA256 "ADH-AES256-SHA256"
+
+// TLS v1.2 GCM ciphersuites from RFC 5288
+#define TLS1_TXT_RSA_WITH_AES_128_GCM_SHA256 "AES128-GCM-SHA256"
+#define TLS1_TXT_RSA_WITH_AES_256_GCM_SHA384 "AES256-GCM-SHA384"
+#define TLS1_TXT_DHE_RSA_WITH_AES_128_GCM_SHA256 "DHE-RSA-AES128-GCM-SHA256"
+#define TLS1_TXT_DHE_RSA_WITH_AES_256_GCM_SHA384 "DHE-RSA-AES256-GCM-SHA384"
+#define TLS1_TXT_DH_RSA_WITH_AES_128_GCM_SHA256 "DH-RSA-AES128-GCM-SHA256"
+#define TLS1_TXT_DH_RSA_WITH_AES_256_GCM_SHA384 "DH-RSA-AES256-GCM-SHA384"
+#define TLS1_TXT_DHE_DSS_WITH_AES_128_GCM_SHA256 "DHE-DSS-AES128-GCM-SHA256"
+#define TLS1_TXT_DHE_DSS_WITH_AES_256_GCM_SHA384 "DHE-DSS-AES256-GCM-SHA384"
+#define TLS1_TXT_DH_DSS_WITH_AES_128_GCM_SHA256 "DH-DSS-AES128-GCM-SHA256"
+#define TLS1_TXT_DH_DSS_WITH_AES_256_GCM_SHA384 "DH-DSS-AES256-GCM-SHA384"
+#define TLS1_TXT_ADH_WITH_AES_128_GCM_SHA256 "ADH-AES128-GCM-SHA256"
+#define TLS1_TXT_ADH_WITH_AES_256_GCM_SHA384 "ADH-AES256-GCM-SHA384"
+
+// ECDH HMAC based ciphersuites from RFC 5289
+
+#define TLS1_TXT_ECDHE_ECDSA_WITH_AES_128_SHA256 "ECDHE-ECDSA-AES128-SHA256"
+#define TLS1_TXT_ECDHE_ECDSA_WITH_AES_256_SHA384 "ECDHE-ECDSA-AES256-SHA384"
+#define TLS1_TXT_ECDH_ECDSA_WITH_AES_128_SHA256 "ECDH-ECDSA-AES128-SHA256"
+#define TLS1_TXT_ECDH_ECDSA_WITH_AES_256_SHA384 "ECDH-ECDSA-AES256-SHA384"
+#define TLS1_TXT_ECDHE_RSA_WITH_AES_128_SHA256 "ECDHE-RSA-AES128-SHA256"
+#define TLS1_TXT_ECDHE_RSA_WITH_AES_256_SHA384 "ECDHE-RSA-AES256-SHA384"
+#define TLS1_TXT_ECDH_RSA_WITH_AES_128_SHA256 "ECDH-RSA-AES128-SHA256"
+#define TLS1_TXT_ECDH_RSA_WITH_AES_256_SHA384 "ECDH-RSA-AES256-SHA384"
+
+// ECDH GCM based ciphersuites from RFC 5289
 #define TLS1_TXT_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256 \
   "ECDHE-ECDSA-AES128-GCM-SHA256"
 #define TLS1_TXT_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384 \
   "ECDHE-ECDSA-AES256-GCM-SHA384"
+#define TLS1_TXT_ECDH_ECDSA_WITH_AES_128_GCM_SHA256 \
+  "ECDH-ECDSA-AES128-GCM-SHA256"
+#define TLS1_TXT_ECDH_ECDSA_WITH_AES_256_GCM_SHA384 \
+  "ECDH-ECDSA-AES256-GCM-SHA384"
 #define TLS1_TXT_ECDHE_RSA_WITH_AES_128_GCM_SHA256 "ECDHE-RSA-AES128-GCM-SHA256"
 #define TLS1_TXT_ECDHE_RSA_WITH_AES_256_GCM_SHA384 "ECDHE-RSA-AES256-GCM-SHA384"
+#define TLS1_TXT_ECDH_RSA_WITH_AES_128_GCM_SHA256 "ECDH-RSA-AES128-GCM-SHA256"
+#define TLS1_TXT_ECDH_RSA_WITH_AES_256_GCM_SHA384 "ECDH-RSA-AES256-GCM-SHA384"
+
 #define TLS1_TXT_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256 \
   "ECDHE-RSA-CHACHA20-POLY1305"
 #define TLS1_TXT_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256 \
   "ECDHE-ECDSA-CHACHA20-POLY1305"
 #define TLS1_TXT_ECDHE_PSK_WITH_CHACHA20_POLY1305_SHA256 \
   "ECDHE-PSK-CHACHA20-POLY1305"
+
+// TLS 1.3 ciphersuites from RFC 8446.
 #define TLS1_3_RFC_AES_128_GCM_SHA256 "TLS_AES_128_GCM_SHA256"
 #define TLS1_3_RFC_AES_256_GCM_SHA384 "TLS_AES_256_GCM_SHA384"
 #define TLS1_3_RFC_CHACHA20_POLY1305_SHA256 "TLS_CHACHA20_POLY1305_SHA256"
 
+// The following constants are legacy aliases of |TLS1_3_CK_*|.
+// TODO(bbe): Migrate callers to the new name and remove these.
+#define TLS1_TXT_AES_128_GCM_SHA256 TLS1_3_RFC_AES_128_GCM_SHA256
+#define TLS1_TXT_AES_256_GCM_SHA384 TLS1_3_RFC_AES_256_GCM_SHA384
+#define TLS1_TXT_CHACHA20_POLY1305_SHA256 TLS1_3_RFC_CHACHA20_POLY1305_SHA256
+
 #define TLS_CT_RSA_SIGN 1
 #define TLS_CT_DSS_SIGN 2
 #define TLS_CT_RSA_FIXED_DH 3
@@ -248,6 +520,17 @@ extern "C" {
 #define TLS_CT_RSA_FIXED_ECDH 65
 #define TLS_CT_ECDSA_FIXED_ECDH 66
 
+#define TLS_MD_MAX_CONST_SIZE 20
+#define TLSEXT_TYPE_record_size_limit 28
+
+// This is not an IANA defined extension number
+// TODO(crbug.com/398275713): Replace with the final codepoint once
+// standardization completes.
+#define TLSEXT_TYPE_trust_anchors 0xca34
+
+// ExtensionType value from draft-ietf-tls-tlsflags.
+#define TLSEXT_TYPE_tls_flags 62
+#define TLSEXT_TYPE_pake 0x8a3b
 
 #ifdef __cplusplus
 }  // extern C
diff --git a/ssl/extensions.cc b/ssl/extensions.cc
index dca1ee323..b6b363db2 100644
--- a/ssl/extensions.cc
+++ b/ssl/extensions.cc
@@ -11,7 +11,7 @@
 // WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 // See the License for the specific language governing permissions and
 // limitations under the License.
-
+#pragma warning(disable : 4834)
 #include <openssl/ssl.h>
 
 #include <assert.h>
@@ -4119,22 +4119,15 @@ bool ssl_add_clienthello_tlsext(SSL_HANDSHAKE *hs, CBB *out, CBB *out_encoded,
 
    if (hasPreSharedKey)
    {
-  // The PSK extension must be last, including after the padding.
-  const size_t len_before = CBB_len(&extensions);
-  if (!ext_pre_shared_key_add_clienthello(hs, &extensions, out_needs_psk_binder,
-                                          type)) {
-    OPENSSL_PUT_ERROR(SSL, ERR_R_INTERNAL_ERROR);
-    return false;
-  }
-  assert(psk_extension_len == CBB_len(&extensions) - len_before);
-  (void)len_before;  // |assert| is omitted in release builds.
-}
-  // Discard empty extensions blocks.
-  if (CBB_len(&extensions) == 0) {
-    CBB_discard_child(out);
-  }
-
-  return CBB_flush(out);
+       // The PSK extension must be last, including after the padding.
+       size_t psk_len_actual;
+       if (!ext_pre_shared_key_add_clienthello(hs, out, &extensions, &psk_len_actual,
+           type)) {
+           return false;
+       }
+}
+   assert(psk_len_actual == psk_len);
+   return true;
 }
 
 bool ssl_add_serverhello_tlsext(SSL_HANDSHAKE *hs, CBB *out) {
diff --git a/ssl/handshake_client.cc b/ssl/handshake_client.cc
index bab8d2730..44be5a966 100644
--- a/ssl/handshake_client.cc
+++ b/ssl/handshake_client.cc
@@ -153,16 +153,16 @@ static bool ssl_write_client_cipher_list(const SSL_HANDSHAKE *hs, CBB *out,
                                 ? ssl->config->aes_hw_override_value
                                 : EVP_has_aes_hardware();
     const bssl::Span<const uint16_t> ciphers =
-        ssl->config->tls13_cipher_policy == ssl_compliance_policy_cnsa_202407
-            ? bssl::Span<const uint16_t>(kCiphersCNSA)
-            : (has_aes_hw ? bssl::Span<const uint16_t>(kCiphersAESHardware)
-                          : bssl::Span<const uint16_t>(kCiphersNoAESHardware));
+        ssl->config->compliance_policy == ssl_compliance_policy_cnsa_202407
+        ? bssl::Span<const uint16_t>(kCiphersCNSA)
+        : (has_aes_hw ? bssl::Span<const uint16_t>(kCiphersAESHardware)
+            : bssl::Span<const uint16_t>(kCiphersNoAESHardware));
 
     for (auto cipher : ciphers) {
-      if (!ssl_add_tls13_cipher(&child, cipher,
-                                ssl->config->tls13_cipher_policy)) {
-        return false;
-      }
+        if (!ssl_add_tls13_cipher(&child, cipher,
+            ssl->config->compliance_policy)) {
+            return false;
+        }
     }
   }
 
diff --git a/ssl/ssl_cipher.cc b/ssl/ssl_cipher.cc
index 0ed36d942..a10329bc4 100644
--- a/ssl/ssl_cipher.cc
+++ b/ssl/ssl_cipher.cc
@@ -249,7 +249,7 @@ static constexpr SSL_CIPHER kCiphers[] = {
     {
     "ECDHE-ECDSA-DES-CBC3-SHA",
     "TLS_ECDHE_ECDSA_WITH_3DES_EDE_CBC_SHA",
-    0x0300C008,
+    0x0000C008,
     SSL_kECDHE,
     SSL_aECDSA,
     SSL_3DES,
@@ -284,7 +284,7 @@ static constexpr SSL_CIPHER kCiphers[] = {
     {
     "ECDHE-RSA-DES-CBC3-SHA",
     "TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA",
-    0x0300C012,
+    0x0000C012,
     SSL_kECDHE,
     SSL_aRSA_DECRYPT,
     SSL_3DES,
@@ -1366,18 +1366,18 @@ static int ssl_cipher_id_cmp_void(const void *in_a, const void *in_b) {
                            reinterpret_cast<const SSL_CIPHER *>(in_b));
 }
 
-template <size_t N>
-static constexpr bool ssl_ciphers_sorted(const SSL_CIPHER (&ciphers)[N]) {
-  for (size_t i = 1; i < N; i++) {
-    if (ssl_cipher_id_cmp(&ciphers[i - 1], &ciphers[i]) >= 0) {
-      return false;
-    }
-  }
-  return true;
-}
-
-static_assert(ssl_ciphers_sorted(kCiphers),
-              "Ciphers are not sorted, bsearch won't work");
+//template <size_t N>
+//static constexpr bool ssl_ciphers_sorted(const SSL_CIPHER (&ciphers)[N]) {
+//  for (size_t i = 1; i < N; i++) {
+//    if (ssl_cipher_id_cmp(&ciphers[i - 1], &ciphers[i]) >= 0) {
+//      return false;
+//    }
+//  }
+//  return true;
+//}
+//
+//static_assert(ssl_ciphers_sorted(kCiphers),
+//              "Ciphers are not sorted, bsearch won't work");
 
 const SSL_CIPHER *SSL_get_cipher_by_value(uint16_t value) {
   SSL_CIPHER c;
diff --git a/ssl/ssl_key_share.cc b/ssl/ssl_key_share.cc
index dbb4db9d4..7d97e2c5c 100644
--- a/ssl/ssl_key_share.cc
+++ b/ssl/ssl_key_share.cc
@@ -450,8 +450,8 @@ constexpr NamedGroup kNamedGroups[] = {
     {NID_secp224r1, 257, "dhe3072", "ffdhe3072"},
 };
 
-static_assert(std::size(kNamedGroups) == kNumNamedGroups,
-              "kNamedGroups size mismatch");
+//static_assert(std::size(kNamedGroups) == kNumNamedGroups,
+//              "kNamedGroups size mismatch");
 
 }  // namespace
 
diff --git a/ssl/ssl_lib.cc b/ssl/ssl_lib.cc
index 871fee633..05e0f9dd7 100644
--- a/ssl/ssl_lib.cc
+++ b/ssl/ssl_lib.cc
@@ -13,7 +13,7 @@
 // WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 // See the License for the specific language governing permissions and
 // limitations under the License.
-
+#pragma warning(disable : 4834)
 #include <openssl/ssl.h>
 
 #include <algorithm>
@@ -566,7 +566,7 @@ SSL *SSL_new(SSL_CTX *ctx) {
   SSL_CTX_set_grease_enabled(ssl->ctx.get(), 1);
   SSL_enable_signed_cert_timestamps(ssl.get());
   SSL_set_enable_ech_grease(ssl.get(), 1);
-
+  SSL_set1_requested_trust_anchors(ssl.get(), nullptr, 0);
   if (!ssl->method->ssl_new(ssl.get()) ||
       !ssl->ctx->x509_method->ssl_new(ssl->s3->hs.get())) {
     return nullptr;
@@ -3476,7 +3476,7 @@ static int Configure(SSL_CTX *ctx) {
 }
 
 static int Configure(SSL *ssl) {
-  ssl->config->tls13_cipher_policy = ssl_compliance_policy_wpa3_192_202304;
+    ssl->config->compliance_policy = ssl_compliance_policy_fips_202205;
 
   return SSL_set_min_proto_version(ssl, TLS1_2_VERSION) &&
          SSL_set_max_proto_version(ssl, TLS1_3_VERSION) &&
-- 
2.36.1.windows.1


From af05bb665bbd94804a799603eea4d17bcf36a099 Mon Sep 17 00:00:00 2001
From: Ossian <857984597@qq.com>
Date: Fri, 13 Feb 2026 11:10:41 +0800
Subject: [PATCH 3/3] patch

---
 ssl/extensions.cc | 2 ++
 ssl/ssl_lib.cc    | 2 ++
 2 files changed, 4 insertions(+)

diff --git a/ssl/extensions.cc b/ssl/extensions.cc
index b6b363db2..40442d97a 100644
--- a/ssl/extensions.cc
+++ b/ssl/extensions.cc
@@ -11,7 +11,9 @@
 // WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 // See the License for the specific language governing permissions and
 // limitations under the License.
+#if defined(_MSC_VER)
 #pragma warning(disable : 4834)
+#endif
 #include <openssl/ssl.h>
 
 #include <assert.h>
diff --git a/ssl/ssl_lib.cc b/ssl/ssl_lib.cc
index 05e0f9dd7..84bef472d 100644
--- a/ssl/ssl_lib.cc
+++ b/ssl/ssl_lib.cc
@@ -13,7 +13,9 @@
 // WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 // See the License for the specific language governing permissions and
 // limitations under the License.
+#if defined(_MSC_VER)
 #pragma warning(disable : 4834)
+#endif
 #include <openssl/ssl.h>
 
 #include <algorithm>
-- 
2.36.1.windows.1

